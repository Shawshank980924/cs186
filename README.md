# Project 4: Concurrency
:::info
ğŸ’¡  ç¬¬å››ä¸ªprojå°±ä¸»è¦å®ç°å¹¶è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹è¿‡ç¨‹ä¸­å¤šç²’åº¦é”çš„ä½¿ç”¨å’Œé‡Šæ”¾ï¼Œä»lockMangeråº•å±‚å¼€å§‹å¾€ä¸ŠLockContextå†åˆ°LockUtilå®Œæˆä¸€å±‚åˆä¸€å±‚çš„å°è£…ï¼Œè¯¥projectä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†

1. part1 Queuing åˆ†ä¸ºä¸¤ä¸ªä¸ªtask
   1. ä¸»è¦ç†è§£IS IX SIX S Xè¿™å‡ ä¸ªé”ä¹‹é—´çš„ç›¸äº’å…¼å®¹å’Œæ›¿ä»£å…³ç³»
   1. å®ç°æœ€åº•å±‚å‡ ä¸ªé”çš„è·å–é‡Šæ”¾æ–¹æ³•ï¼Œå¹¶å®ç°queuing logicå¹¶å­¦ä¼šè¿ç”¨synchronizedå®ç°åŸå­æ€§å’Œæœ‰åºæ€§ä»£ç 
2. part2 åˆ†ä¸ºä¸‰ä¸ªtask
   1. lockContextå°è£…LockMangerçš„æ–¹æ³•å¹¶æ‰§è¡Œå¤šç²’åº¦é”é™åˆ¶æ¡ä»¶çš„æ£€æŸ¥
   1. å°è£…LockContextçš„æ–¹æ³•å¹¶è‡ªåŠ¨åˆ¤æ–­å’Œè°ƒæ•´ancestorsèŠ‚ç‚¹å’Œå½“å‰å±‚èŠ‚ç‚¹é”çŠ¶æ€
   1. å®ç°strict 2PL
      :::
## Part-1ï¼šTask 1 LockType

- [x] projectä¸­æ¶‰åŠçš„å‡ ç§é”çš„ç‰¹æ€§

æ„Ÿè§‰è¿™å‡ ä¸ªé”å®šä¹‰çš„æŒºæ¨¡ç³Šçš„ï¼Œåšprojectçš„æ—¶å€™æœ‰æ—¶å€™æ¦‚å¿µä¸å¤ªæ¸…æ¥šï¼Œæˆ‘ä¹Ÿæ˜¯å‡­ç€è‡ªå·±çš„ç†è§£å†™ä¸€ä¸‹ï¼š

- S(A) æŸä¸ªtransactionå¯¹AåŠ Sé”å°±æ˜¯å¯ä»¥è¯»Aä»¥åŠAä»¥ä¸‹çš„èµ„æºï¼Œæ¯”å¦‚Aæ˜¯æŸä¸ªtableï¼Œé‚£ä¹ˆå°±èƒ½è¯»è¯¥tableä¸‹æ‰€æœ‰çš„pageï¼Œä¸åŒçš„tranctionå¯ä»¥å¯¹åŒä¸€ä¸ªAåŒæ—¶æŒæœ‰Sé”ï¼Œ
- X(A) æŸä¸ªtransactionå¯¹AåŠ Sé”å°±æ˜¯å¯ä»¥è¯»ä»¥åŠå†™Aä»¥åŠAä»¥ä¸‹çš„èµ„æºï¼Œå› ä¸ºåŠ äº†å†™çš„æƒé™æ‰€ä»¥Aä¸èƒ½å†è¢«å…¶ä»–transactionæŒæœ‰Xæˆ–è€…Sé”
- IS(A) è¿™ä¸ªè¡¨ç¤ºAä»¥ä¸‹æœ‰èµ„æºè¢«è¯¥transactionä¸Šäº†Sé”ï¼ˆä½†ä¸ä¸€å®šæ˜¯å…¨éƒ¨èµ„æºï¼‰ï¼Œæ³¨æ„ISä¸‹åªèƒ½å­˜åœ¨Sæˆ–è€…ISé”ï¼Œä¸å¯èƒ½å­˜åœ¨Xé”
- IX(A) è¿™ä¸ªè¡¨ç¤ºAä»¥ä¸‹æœ‰èµ„æºè¢«è¯¥transactionä¸Šäº†Xé”ï¼ˆä½†ä¸ä¸€å®šæ˜¯å…¨éƒ¨èµ„æºï¼‰ï¼Œæ³¨æ„IXä¸‹ä¹Ÿå¯ä»¥å­˜åœ¨ISæˆ–è€…Sé”ï¼Œæ‰€ä»¥è¯´IXä¸‹å¯ä»¥è·å–ä»»æ„ç§ç±»çš„é”
- SIX(A) è¿™ä¸ªé”å¯ä»¥çœ‹ä½œä¸€ä¸ªtransactionå¯¹ä¸€ä¸ªèµ„æºåŒæ—¶è·å–äº†Så’ŒIXé”ï¼Œè¿™æ˜¯å•¥æ„æ€å‘¢ï¼Œå°±æ˜¯Aä¸‹çš„èµ„æºé™¤äº†éœ€è¦å†™å…¥çš„èµ„æºè·å–Xé”ä»¥å¤–å…¶ä½™å‡è·å–Sé”ï¼ˆå½“ç„¶è¿˜ä¼šæœ‰IXé”ï¼‰ï¼Œå‡è®¾Aæ˜¯databaseç”»å¼ å›¾ç†è§£ä»¥ä¸‹å°±æ˜¯ï¼š

![](https://cdn.nlark.com/yuque/0/2022/jpeg/25488814/1658029090874-42ef66de-3586-4e2c-9746-fd11cadbfaed.jpeg)

- éœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†ç®€æ´æ€§ï¼ŒSIXä¸‹ä¸å…è®¸å‡ºç°ISæˆ–è€…Sæˆ–è€…SIXï¼Œä»¥ä¸Šè¯´çš„æ˜¾å¼çš„å¸¦é”ï¼Œå›¾ä¸­åŠ ç²—çš„éƒ¨åˆ†çš„Sæ˜¯éšå¼çš„å¸¦é”ï¼Œæ‰€è°“éšå¼çš„å¸¦é”æ˜¯æŒ‡æ˜¾å¼ä¸å¸¦é”ï¼Œé”æ¥æºäºè‡ªå·±çš„ancestorsï¼Œè¿™é‡Œä¹Ÿå°±æ˜¯SIXï¼Œä¹Ÿå’Œä¹‹åå®ç°çš„effectiveLockTypeå’ŒexplicitLockTypeå‡½æ•°æœ‰ç‚¹ç›¸å…³ï¼Œæ­¤å¤„å…ˆæŒ‰ä¸‹ä¸è¡¨
- è‹¥ä¸€ä¸ªèµ„æºå¸¦äº†Sæˆ–è€…Xé”ï¼Œå…¶ä¸‹çš„æ‰€æœ‰èµ„æºä¸èƒ½æ˜¾å¼çš„å¸¦æœ‰å…¶ä»–é”
> æ˜¾å¼å’Œéšå¼çš„åŒºåˆ«å’Œè”ç³»å¯ä»¥å‚è€ƒpptä¸Šè¿™å¥è¯explicitlyå°±æ˜¯æ˜¾å¼å¸¦é”ï¼Œimplicitlyå°±æ˜¯éšå¼å¸¦é”
> â€¢When a transaction locks a node in the tree **explicitly**, it **implicitly** locks all the nodeâ€™s descendants in the same mode.

- [x] Intent Lockå³ä¸Šé¢å¸¦Içš„é”åˆ°åº•æœ‰ä»€ä¹ˆç”¨

é¦–å…ˆéœ€è¦çŸ¥é“ILockåŠ çš„åŸåˆ™æ˜¯ä»€ä¹ˆï¼Œå¯ä»¥å‚è€ƒLockType.parentLockä¸­çš„ä»£ç ï¼Œå½“ä¸€ä¸ªå­èŠ‚ç‚¹è·å–Xæ—¶å®ƒçš„ancestorsèŠ‚ç‚¹è‡³å°‘è¦è·å–IXé”ï¼Œå­èŠ‚ç‚¹è·å–Sæ—¶å®ƒçš„æ‰€æœ‰ancestorsèŠ‚ç‚¹è‡³å°‘è¦è·å–ISé”
å¸¦Içš„é”ä¸»è¦å¯¹å…¶ä»–transactionæå‰åˆ¤æ–­æ˜¯å¦æœ‰æƒé™å»è¯»æˆ–è€…å†™å¦‚ä¸€ä¸ªtableï¼Œè€Œæ— éœ€éå†è¯¥tableä¸‹æ‰€æœ‰çš„pageï¼Œè‹¥ä¸€ä¸ªtableä¸‹æœ‰pageæœ‰Sé”ï¼Œtableä¸Šè‡³å°‘æœ‰ä¸ªISé”ï¼Œè¿™æ ·è‹¥å…¶ä»–transactionè¦å¯¹tableåŠ Xé”é€šè¿‡åˆ¤æ–­tableä¸Šæœ‰ISå°±çŸ¥é“æ— æ³•è·å–tableçš„X
çˆ¶èŠ‚ç‚¹ä¸Šçš„Intent Lockå¯¹åº”çš„æ˜¯ç²—ç²’åº¦é”ï¼ˆCoarse granularity ï¼‰ï¼Œå­èŠ‚ç‚¹åŠ çš„Sæˆ–è€…X Lockå¯¹åº”çš„ç»†ç²’åº¦é”(Fine granularity)ï¼Œç²—ç»†ç²’åº¦é”å„æœ‰ä¼˜ç¼ºç‚¹ï¼Œå‚è€ƒppt
> â€¢Fine granularity (lower in tree):  High concurrency, lots of locks (overhead)
> â€¢Coarse granularity (higher in tree): Few locks (low overhead), lost concurrency

- [x] å•ä¸ªtranctionå¯¹å•ä¸ªresourceåªèƒ½åŒæ—¶è·å–ä¸€ä¸ªé”

ä¾‹å¦‚å¯¹æŸä¸ªtableï¼Œtransactionåªèƒ½æœ€å¤šå¯¹å…¶æŒæœ‰ä¸Šè¿°çš„ä¸€ä¸ªé”ï¼Œè‹¥æ˜¾å¼å¸¦é”é‚£ä¹ˆæŒæœ‰çš„å°±æ˜¯æ˜¾å¼å¸¦çš„é”ï¼Œè‹¥æ˜¾å¼ä¸å¸¦é”å†çœ‹éšå¼å¸¦çš„é”ï¼Œè™½ç„¶ä¸èƒ½åŒæ—¶æŒæœ‰ä½†æ˜¯é”ä¸é”ä¹‹é—´æœ‰ç­‰çº§æ›¿æ¢å…³ç³»æ¯”å¦‚Xå¯ä»¥æ›¿æ¢S

- [x] é”çš„å…¼å®¹æ€§compatibilityä»¥åŠcanbeparentå’Œsubstituteæ€ä¹ˆçœ‹
- é”çš„å…¼å®¹æ€§æŒ‡çš„æ˜¯ä¸åŒçš„transactionå¯¹åŒä¸€ä¸ªèµ„æºæ˜¯å¦å¯ä»¥åŒæ—¶å„è‡ªæŒæœ‰æŸé”ï¼ˆè¿™ä¸ªé”å¯ä»¥ä¸åŒï¼‰å¯¹äºIlockåˆ¤æ–­æ ‡å‡†å°±æ˜¯åªè¦å­˜åœ¨æŸç§æƒ…å†µä¸‹æ˜¯ç¬¦åˆçš„å°±è¡Œæ¯”å¦‚ISå’ŒSIXåªè¦ISåŠ çš„ä¸æ˜¯Xçš„èµ„æºå³å¯ï¼Œè¯¦è§ä¸‹å›¾
```java
/**
     * Compatibility Matrix
     * (Boolean value in cell answers is `left` compatible with `top`?)
     *
     *     | NL  | IS  | IX  |  S  | SIX |  X
     * ----+-----+-----+-----+-----+-----+-----
     * NL  |  T  |  T  |  T  |  T  |  T  |  T
     * ----+-----+-----+-----+-----+-----+-----
     * IS  |  T  |  T  |  T  |  T  |  t  |  f
     * ----+-----+-----+-----+-----+-----+-----
     * IX  |  T  |  T  |  T  |  F  |  f  |  f
     * ----+-----+-----+-----+-----+-----+-----
     * S   |  T  |  T  |  F  |  T  |  F  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * SIX |  T  |  t  |  f  |  F  |  f  |  f
     * ----+-----+-----+-----+-----+-----+-----
     * X   |  T  |  f  |  f  |  F  |  f  |  F
     * ----+-----+-----+-----+-----+-----+-----
     *
*/
```

- é”çš„canBeparentåˆ¤æ–­ç”¨äºåŒä¸€ä¸ªtransactionä¸­å¯¹äºä¸Šä¸‹ä¸¤å±‚çš„èµ„æºåŠ çš„é”æ˜¯å¦é€‚é…ï¼Œè¿™ä¸ªæ–¹æ³•ä¸»è¦ç”¨äºä¹‹åå‡çº§é”æ—¶åˆ¤æ–­å¯¹äºçˆ¶èŠ‚ç‚¹æ˜¯å¦éœ€è¦æ”¹åŠ¨ï¼Œæ³¨æ„è¿™é‡ŒæŒ‡çš„éƒ½æ˜¯æ˜¾å¼å¸¦é”

å…·ä½“è§ä¸‹è¡¨ï¼Œåˆ¤æ–­æ–¹æ³•å¯ä»¥çœ‹ä»£ç æ–‡æ¡£å¯¹äºå„ç§é”çš„è¯´æ˜
```java
/**
     * Parent Matrix
     * (Boolean value in cell answers can `left` be the parent of `top`?)
     *
     *     | NL  | IS  | IX  |  S  | SIX |  X
     * ----+-----+-----+-----+-----+-----+-----
     * NL  |  T  |  F  |  F  |  F  |  F  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * IS  |  T  |  T  |  F  |  T  |  F  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * IX  |  T  |  T  |  T  |  T  |  T  |  T
     * ----+-----+-----+-----+-----+-----+-----
     * S   |  T  |  f  |  f  |  f  |  f  |  f
     * ----+-----+-----+-----+-----+-----+-----
     * SIX |  T  |  f  |  t  |  f  |  f  |  t
     * ----+-----+-----+-----+-----+-----+-----
     * X   |  T  |  f  |  f  |  f  |  f  |  f
     * ----+-----+-----+-----+-----+-----+-----
     *
     */
```

- é”çš„å¯æ›¿æ¢æ€§å°±æ˜¯æŒ‡ç”¨é«˜ç­‰çº§çš„é”å»æ›¿æ¢ä½ç­‰çº§çš„é”ï¼Œåœ¨åŸæ¥çš„åŸºç¡€ä¸Šé”æ›´å¼ºäº†å°±èƒ½æ›¿æ¢ï¼Œæˆ–è€…è¯´åŸæ¥çš„æ“ä½œåœ¨æ–°çš„é”ä»¥ä¸‹éƒ½èƒ½åšå°±è¡¨ç¤ºå¯ä»¥æ›¿æ¢ï¼Œå…·ä½“è§ä¸‹è¡¨å·¦è¾¹çš„æ›¿æ¢ä¸Šè¾¹
```java
  /**
     * Substitutability Matrix
     * (Values along left are `substitute`, values along top are `required`)
     *
     *     | NL  | IS  | IX  |  S  | SIX |  X
     * ----+-----+-----+-----+-----+-----+-----
     * NL  |  T  |  F  |  F  |  F  |  F  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * IS  |  T  |  T  |  F  |  F  |  f  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * IX  |  T  |  T  |  T  |  F  |  F  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * S   |  T  |  t  |  f  |  T  |  f  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * SIX |  T  |  t  |  t  |  T  |  T  |  F
     * ----+-----+-----+-----+-----+-----+-----
     * X   |  T  |  t  |  t  |  T  |  t  |  T
     * ----+-----+-----+-----+-----+-----+-----
     *
```

- [x] checkCompatibleä¸­çš„except

exceptæ˜¯ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼Œä¸€èˆ¬æ¥è¯´å…¼å®¹æ€§æ£€æŸ¥åº”è¯¥å¯¹äºä¸åŒçš„transacitonï¼Œç”±äºtask2ä¸­çš„acquireAndReleaseå¯èƒ½releaseå’Œacquireä¸­å­˜åœ¨å¯¹ç›¸åŒtransactionå¯¹äºç›¸åŒèµ„æºçš„é”ä»¥åŠpromoteå‡½æ•°è°ƒç”¨ï¼Œä¸ºäº†è¾…åŠ©åˆ¤æ–­è¿™ä¸ªï¼Œä¼ å…¥å‚æ•°åŠ å…¥transactionä½œä¸ºexceptï¼Œç›¸åŒtransactionåªè¦å¯æ›¿æ¢å°±ä¹Ÿèƒ½ç®—å…¼å®¹çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µ
## Part-1ï¼šTask 2 LockManager

- [x] Lockmanagerçš„å…·ä½“ä½œç”¨

å…¨å±€æ‰€æœ‰çš„transactionå…±ç”¨ä¸€ä¸ªLockManagerå®ä¾‹ï¼ŒLockManagerç®¡ç†ç€æ¯ä¸ªtransactionæŒæœ‰çš„é”ï¼Œä»¥åŠç»´æŠ¤ç€å¯¹äºæ¯ä¸ªresourceï¼ŒæŒæœ‰è¯¥resourceçš„æ‰€æœ‰çš„é”ä»¥åŠé˜Ÿåˆ—ä¸­ç­‰å¾…æŒæœ‰çš„é”ï¼Œå¯¹äºç­‰å¾…æŒæœ‰çš„é”æ‰€åœ¨çš„transactionå¤„äºè¢«æŒ‚èµ·é˜»å¡blockçš„çŠ¶æ€ï¼Œå¯ä»¥å€Ÿç”¨ä¸€å¼ Discussionä¸­çš„è¡¨æ¥è¡¨ç¤ºLockManagerä¸­çš„åŒ…å«çš„ä¿¡æ¯
![](https://cdn.nlark.com/yuque/0/2022/png/25488814/1657246760405-e5b2c9ff-ff22-4586-908a-0308b78032dd.png#crop=0&crop=0&crop=1&crop=1&from=url&id=mgwhs&margin=%5Bobject%20Object%5D&originHeight=280&originWidth=639&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=)

- [x] å…³äºå„ä¸ªæ–¹æ³•çš„è°ƒç”¨é€»è¾‘å…³ç³»ä»¥åŠå®ç°çš„ä¸€äº›ç»†èŠ‚é—®é¢˜

è¿™é‡Œçš„é”ç›¸å…³çš„è°ƒç”¨æ–¹æ³•éå¸¸å¤šï¼Œæ–‡æ¡£æè¿°çš„ä¹Ÿæ¯”è¾ƒæ¨¡ç³Šï¼Œè°ƒç”¨é€»è¾‘ä»¥åŠå„ä¸ªå‡½æ•°çš„ä½œç”¨å®¹æ˜“æ··æ·†ï¼Œå¯ä»¥è¿™æ ·æ¥ååŠ©åˆ†æï¼šacquireAndRelease acquire  releaseä»¥åŠpromoteä¸‰ä¸ªæ–¹æ³•ä¸­å¸¦äº†åŒæ­¥å…³é”®å­—synchronizedï¼Œè¯´æ˜è¿™æ˜¯è°ƒç”¨çš„å…¥å£æ–¹æ³•ï¼Œå…¶ä»–ä¸å¸¦è¯¥å…³é”®å­—çš„åº”è¯¥è¢«ä»¥ä¸Šä¸‰ä¸ªæ–¹æ³•æ¥è°ƒç”¨
ä¸‰ä¸ª

1. acquireAndReleaseï¼š
   1. è‹¥åŸæ¥è¯¥transactionå¯¹è¯¥èµ„æºå°±æŒæœ‰é”ï¼Œéœ€è¦åˆ¤æ–­æ˜¯å¦åœ¨releaseNamesä¸­æ˜¯å¦å­˜åœ¨è‡ªèº«ï¼Œè‹¥ä¸å­˜åœ¨æ‰éœ€è¦æŠ›å‡ºé”™è¯¯
   1. ä¸ºäº†ä»£ç çš„å¥å£®æ€§ï¼Œcheccompatibilityä»¥åå…·ä½“æ‰§è¡Œçš„æ—¶å€™åº”è¯¥å…ˆé‡Šæ”¾é”ç„¶åå†è·å–é”ï¼Œå› ä¸ºè‹¥å…ˆè·å–å¯èƒ½å‡ºç°åŸèµ„æºå·²æœ‰é”ä¸”ä¸å¯æ›¿æ¢çš„æƒ…å†µ
   1. releaseNamesä¸Šçš„é”å¿…é¡»å…¨éƒ¨å­˜åœ¨
2. acquire
   1. åªæœ‰é˜Ÿåˆ—ä¸ºç©ºä¸”ä¸å½“å‰è¯¥èµ„æºæŒæœ‰çš„é”å…¼å®¹æ—¶æ‰èƒ½ç›´æ¥è·å–é”ï¼Œå¦åˆ™éœ€è¦å†é˜Ÿåˆ—ä¸­è¿½åŠ 
   1. ä¸å‰è€…ä¸åŒï¼Œä¸å…è®¸é”çš„å‡çº§ï¼Œå› ä¸ºgrantUpdateä¸­æœ‰é”æ›¿æ¢çš„é€»è¾‘ï¼Œæ‰€ä»¥doubleLockçš„åˆ¤æ–­éœ€è¦åœ¨acquireå°±å®Œæˆ
3. release
   1. è¿™é‡Œæœ‰ä¸ªå‘ç‚¹ï¼Œè§‚å¯ŸgetLockå‡½æ•°`return new ArrayList<>(transactionLocks.getOrDefault(transaction.getTransNum(),Collections._emptyList_()));`è¿”å›çš„ä¸æ˜¯ä¸€ä¸ªtransactionLocks Map valueçš„ä¸€ä¸ªå¼•ç”¨è¿˜æ˜¯å¤åˆ»äº†ä¸€ä¸ªArrayListï¼Œæ‰€ä»¥åˆ é™¤ä¸èƒ½ç”¨è¿™ä¸ªæ–¹æ³•æ¥è·å–è¯¥transactionæŒæœ‰çš„æ‰€æœ‰é”ï¼Œè€Œæ˜¯ç›´æ¥è°ƒç”¨transactionLocks.get
   1. releaseæœ‰ä¸¤ä¸ªåœ°æ–¹çš„é”éœ€è¦é‡Šæ”¾ï¼Œä¸€ä¸ªæ˜¯åœ¨transactionLocksä¸­ç»´æŠ¤çš„è¯¥transactionå¯¹è¯¥resourceæŒæœ‰çš„é”ï¼Œè¿™ä¸ªåº”è¯¥åœ¨releaseæ¯å‡½æ•°ä¸­å®Œæˆï¼Œå¦ä¸€ä¸ªæ˜¯åœ¨ResourceEntryä¸­ç»´æŠ¤è¯¥èµ„æºçš„æŒæœ‰é”ä¸­åˆ é™¤è¯¥transactionå¯¹åº”çš„é”ï¼Œå¯¹åº”çš„æ˜¯`ResourceEntry.releaseLock`æ–¹æ³•
   1. è¿™é‡Œéœ€è¦è¾¹éå†è¾¹åˆ é™¤å¿…é¡»ä½¿ç”¨è¿­ä»£å™¨æ‰èƒ½å®‰å…¨åˆ é™¤å³`iterator.remove`
   1. é‡Šæ”¾ä¸€ä¸ªé”ä»¥åéœ€è¦è°ƒç”¨`processQueue`å› ä¸ºæŒæœ‰é”å˜åŒ–åå¯èƒ½å¯ä»¥æ¨è¿›é˜Ÿåˆ—ï¼Œè·å–æ–°çš„é”ï¼Œæ³¨æ„`processQueue`ä¸­åº”è¯¥æ˜¯ä¸ªå¾ªç¯åˆ¤æ–­é€»è¾‘è·å–é”ç›´åˆ°æ— æ³•ç»§ç»­è·å–ä¸ºæ­¢
4. promote
   1. NLä¸å¯promoteï¼ŒåŒä¸€ä¸ªtransaction promoteçš„é”ä¸ä¹‹å‰ç›¸åŒä¹Ÿä¸å¯ï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦å…¼å®¹ï¼Œæ³¨æ„ä¸å¯æ›¿æ¢çš„åˆ¤æ–­åº”è¯¥åœ¨promoteä¸­åˆ¤æ–­ï¼ŒgrantUpdateæ˜¯ç›´æ¥æ›¿æ¢çš„
## Part-2ï¼šTask 3: LockContext
![image.png](https://cdn.nlark.com/yuque/0/2022/png/25488814/1658037875816-48ed0f2d-65b6-44df-a79d-675af5551743.png#clientId=ua1996f64-888b-4&crop=0&crop=0&crop=1&crop=1&from=paste&id=u3a159407&margin=%5Bobject%20Object%5D&name=image.png&originHeight=456&originWidth=986&originalType=url&ratio=1&rotation=0&showTitle=false&size=81408&status=done&style=none&taskId=ud1e07272-9990-43a8-b770-ff7c4b3c2a7&title=)
æ ¹æ®proj4çš„æ¶æ„å›¾ï¼Œåœ¨å®ç°lockManagerä»¥åï¼Œå®ç°äº†å¯¹äºä¸åŒèµ„æºå’Œä¸åŒtransactionæŒæœ‰é”ä»¥åŠqueuing logicçš„ç»´æŠ¤ï¼Œä¸Šä¸€å±‚æ˜¯LockContextï¼Œåœ¨è¿™ä¸€å±‚é‡Œé€šè¿‡locktextå¯¹è±¡ç®¡ç†ä¸åŒçº§åˆ«çš„resourceï¼Œè¿™ä¸€å±‚çº§çš„é”çš„è·å–å’Œé‡Šæ”¾ä¸ä»…ä»…æ˜¯è°ƒç”¨lockManagerï¼Œè€Œä¸”è¿˜ä¼šæ£€æŸ¥å’Œæ›´æ–°ancestorså’ŒDescendantsæŒæœ‰é”çš„çŠ¶æ€ç¡®ä¿ç¬¦åˆå¤šç²’åº¦é”é™åˆ¶æ¡ä»¶Multigranularity constrainsï¼Œä¹Ÿå°±æ˜¯canBeparentç­‰çš„é™åˆ¶æ¡ä»¶

- [x] `getExplicitLockType`å’Œ`getEffectiveLockType`çš„åŒºåˆ«

getExplicitLockTypeç”¨äºå¾—åˆ°æŸtransactionåœ¨è¯¥èµ„æºä¸‹æ˜¾å¼å¸¦çš„é”å³`this.lockman.getLockType`çš„æ–¹æ³•ç»“æœ
`getEffectiveLockType`é¦–å…ˆåˆ¤æ–­æ˜¾å¼å¸¦çš„é”ï¼Œè‹¥æ˜¾å¼å¸¦é”ï¼Œç›´æ¥è¿”å›æ˜¾å¼é”ï¼›è‹¥æ˜¾å¼ä¸å¸¦é”ï¼Œæ‰¾éšå¼å¸¦çš„é”ï¼Œéœ€è¦å¾€ä¸Šå±‚é€’å½’è°ƒç”¨æœ¬å‡½æ•°ï¼Œè¿”å›çš„ç»“æœè‹¥æ˜¯Sæˆ–è€…æ˜¯Xç›´æ¥è¿”å›è¯¥ç»“æœï¼Œè‹¥æ˜¯IXï¼Œéœ€è¦åˆ¤æ–­ancestorsä¸­æ˜¯å¦å­˜åœ¨SIXé”ï¼Œè‹¥å­˜åœ¨è¿”å›Sï¼Œè‹¥ä¸å­˜åœ¨è¿”å›NLï¼›å…¶ä½™æƒ…å†µå‡è¿”å›NL

- [x] å‡ ä¸ªå®ç°å‡½æ•°ä¸­çš„ç»†èŠ‚å’Œæ˜“é”™éƒ¨åˆ†

å‡ ä¸ªå‡½æ•°çš„å®ç°æµç¨‹åŸºæœ¬å†…å®¹ä¸»è¦åˆ†ä¸ºæ£€æŸ¥Multigranularity constrainså’Œè°ƒç”¨lockManagerçš„ç›¸å…³å‡½æ•°

1. acquire
   1. æ³¨æ„æ˜¯å¦æœ‰é”æŠ›é”™åº”è¯¥ç”¨çš„æ˜¯effectiveLock
   1. é™¤äº†é€šè¿‡canBeParentåˆ¤æ–­çˆ¶èŠ‚ç‚¹çš„åˆæ³•æ€§ä»¥å¤–éœ€è¦æ›´æ–°çˆ¶èŠ‚ç‚¹çš„lockcontextä¸­ç»´æŠ¤çš„å­èŠ‚ç‚¹çš„é”çš„æ•°é‡
2. release
   1. é€šè¿‡numchildrenæ¥åˆ¤æ–­å­èŠ‚ç‚¹ä¸­æ˜¯å¦æŒæœ‰æ˜¾å¼é”ï¼Œæ³¨æ„numchildrenå­˜å‚¨çš„æ˜¯æ˜¾å¼é”æ•°é‡ï¼Œéšå¼é”ä¸è®¡å…¥ï¼Œè‹¥æŒæœ‰æŠ›é”™
   1. åŒä¸Šè®°å¾—æ›´æ–°numchildren
3. promote
   1. ç”±äºSIXåœ¨ä»£ç æ–‡æ¡£ä¸­ç‰¹åˆ«è¯´æ˜ï¼ŒSIXä¸‹åªèƒ½å­˜åœ¨IX Xä¸¤ç§æ˜¾å¼é”ï¼Œæ‰€ä»¥åœ¨æå‡ä¸ºSIXä¹‹å‰éœ€è¦é‡Šæ”¾descendantsä¸­æ‰€æœ‰çš„S å’ŒISé”ï¼ˆ**å…¶å®æˆ‘è§‰å¾—åº”è¯¥è¿˜è¦é‡Šæ”¾SIXé”**ï¼‰ï¼Œä»¥åŠè¿˜è¦ä¿è¯è¯¥ç‚¹ä»¥ä¸Šä¸èƒ½å­˜åœ¨SIXèŠ‚ç‚¹
   1. åœ¨SIXæƒ…å†µä¸‹ç”±äºåº”è¯¥åªèƒ½è°ƒç”¨lockMangerä¸€æ¬¡å®ç°åŸå­æ€§ï¼Œä¸­é—´çŠ¶æ€ä¸å¯è§ï¼Œä¸€æ¬¡æ€§çš„é‡Šæ”¾å¤šä¸ªé”åº”è¯¥è°ƒç”¨acquireAndReleaseå‡½æ•°ï¼Œå…¶ä½™æƒ…å†µç›´æ¥è°ƒç”¨lockManager.promoteå³å¯
   1. æ³¨æ„é‡Šæ”¾é”ä¸­é™¤äº†è‡ªå·±ä»¥å¤–å…¶ä»–é”çš„çˆ¶èŠ‚ç‚¹çš„numchildrenéƒ½åº”è¯¥æ”¹å˜
4. escalate
   1. è¿™ä¸ªå‡½æ•°ä½œç”¨å°±æ˜¯å›æ”¶æ‰€æœ‰ä¸‹å±‚èµ„æºçš„ç»†ç²’åº¦é”ï¼Œä»¥æœ€å°ä»£ä»·è½¬ä¸ºè¯¥å±‚çš„ç²—ç²’åº¦é”ï¼ˆé™åˆ¶ä¸ºSæˆ–è€…Xï¼‰ä½†æˆ‘è§‰å¾—å®ƒæ–‡æ¡£æè¿°å’Œæµ‹è¯•æ–‡ä»¶ä¸­ç•¥æœ‰ä¸ç¬¦ï¼ŒæŒ‰æ–‡æ¡£ç†è§£åº”è¯¥éå†æ‰€æœ‰çš„å­èŠ‚ç‚¹åˆ¤æ–­æ˜¯å¦å­˜åœ¨å¸¦Xé”çš„èµ„æºèŠ‚ç‚¹ï¼Œè‹¥æ²¡æœ‰åˆ™è¯¥å±‚è½¬åŒ–ä¸ºSï¼Œè‹¥æœ‰åˆ™è¯¥å±‚è½¬åŒ–ä¸ºXï¼Œä½†ä»`testEscalateIXX`æ¥çœ‹åªæ˜¯ä»è¯¥å±‚ç°åœ¨å¸¦çš„é”æ¥è¿›è¡Œåˆ¤æ–­ï¼Œè‹¥è¯¥å±‚å¸¦Sæˆ–è€…Xï¼Œè¡¨æ˜æ— éœ€å¤„ç†ç›´æ¥è¿”å›ï¼›è‹¥è¯¥å±‚å¸¦IXæˆ–è€…SIXï¼Œè½¬åŒ–ä¸ºXï¼›å…¶ä½™æƒ…å†µå‡è½¬åŒ–ä¸ºSé”
   1. 3.bä¸­ç›¸åŒéœ€è¦ä½¿ç”¨acquireAndReleaseæ–¹æ³•å®ç°åªè°ƒç”¨ä¸€æ¬¡lockManager
   1. `LockContext._fromResourceName_`_é™æ€æ–¹æ³•å¯ä»¥å¸®åŠ©è·å–ä¸‹å±‚çš„lockContext_
## Part-2ï¼šTask 4: LockUtil
è¯¥å±‚ä½äºæ¶æ„å›¾çš„æœ€ä¸Šå±‚ï¼Œä¸»è¦å‘ç”¨æˆ·å°è£…lockContexté”çš„é‡Šæ”¾å’Œä½¿ç”¨ï¼Œå®ç°ä¸¤ä¸ªæ–¹é¢çš„ä½œç”¨

1. åˆ¤æ–­å½“å‰é”çš„çŠ¶æ€æ˜¯å¦å·²ç»æ»¡è¶³requestäº†ä¾‹å¦‚AåŸæ¥å·²ç»åŠ äº†Xï¼Œå¯¹äºåŒä¸€ä¸ªtransactionå‘å¯¹Aè·å–Sï¼Œå·²ç»æ»¡è¶³æ¡ä»¶ç›´æ¥è¿”å›å³å¯ï¼Œç”¨æˆ·ä¸çŸ¥é“å…·ä½“è·å–çš„é”ä½†æ˜¯å·²ç»æ»¡è¶³äº†æ¡ä»¶
1. ä¸æ»¡è¶³ï¼Œéœ€è¦è°ƒæ•´é”æ—¶ï¼Œå…ˆè°ƒæ•´ancestorsèŠ‚ç‚¹çš„çŠ¶æ€ä½¿å…¶æ»¡è¶³è¦æ±‚ç„¶åå†è°ƒç”¨lockContextçš„ç›¸å…³æ–¹æ³•è·å–è¯¥å±‚çš„é”
- [x] æ€ä¹ˆè°ƒæ•´ancestorsèŠ‚ç‚¹è·å–é”çš„çŠ¶æ€

å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„`ancestorEnsuring`å‡½æ•°ï¼Œé€šè¿‡LockType.parentLockè·å–çˆ¶èŠ‚ç‚¹è‡³å°‘è¦è·å–çš„é”ç±»å‹ï¼Œç„¶ååˆ¤æ–­å½“å‰çˆ¶èŠ‚ç‚¹æ˜¯å¦å·²ç»è¦†ç›–äº†è¯¥ç­‰çº§çš„é”ï¼Œè‹¥å·²ç»è¦†ç›–äº†ç›´æ¥è¿”å›ï¼›è‹¥æœªè¦†ç›–ï¼Œé€’å½’è°ƒç”¨æœ¬å‡½æ•°åå…ˆè°ƒæ•´å…¶çˆ¶èŠ‚ç‚¹ç„¶åå†è°ƒç”¨LockContextçš„å‡½æ•°è°ƒæ•´è¯¥å±‚èŠ‚ç‚¹çš„é”ï¼Œè¿™å¾ˆå…³é”®ï¼Œå› ä¸ºè°ƒç”¨lockContextå‰é¦–å…ˆè¦ä¿è¯çˆ¶èŠ‚ç‚¹é”æ˜¯æ»¡è¶³å¤šç²’åº¦é”çº¦æŸçš„

- [x] æ€ä¹ˆæ ¹æ®requestä¸­é”ä»¥åŠç°æœ‰çš„çŠ¶æ€æ¥è°ƒæ•´é”å‘¢

å‚è€ƒä»£ç æ³¨é‡Šä¸­çš„å‡ ç§æƒ…å†µæ¥å®ç°ä»£ç 
> _* - The current lock type can effectively substitute the requested type
* - The current lock type is IX and the requested lock is S
* - The current lock type is an intent lock
* - None of the above: In this case, consider what values the explicit
*   lock type can be, and think about how ancestor locks will need to be
*   acquired or changed._

1. å½“å‰å±‚çš„é”ç­‰çº§å¤§äºç­‰äºrequestï¼Œè¿™ç§æƒ…å†µä¸‹å¯ä»¥ç›´æ¥è¿”å›
1. å½“å‰å¸¦çš„é”æ˜¯IXï¼Œrequestæ˜¯Sï¼Œè¿™ç§æƒ…å†µä¸‹åº”è¯¥promoteä¸ºSIXé”
1. å½“å‰çš„é”æ˜¯intent lockï¼Œè¿™ç§æƒ…å†µéœ€è¦å¯¹requestè¿›è¡Œåˆ†ç±»è®¨è®ºè¯¦ç»†åˆ†æä¸€ä¸‹ï¼š
   1. è‹¥requestæ˜¯Xï¼Œé‚£ä¹ˆXå¯ä»¥æ›¿æ¢æ‰€æœ‰çš„Ié”
   1. è‹¥requestæ˜¯Sï¼Œé‚£ä¹ˆSå¯ä»¥æ›¿æ¢é™¤äº†SIXå’ŒIXä»¥å¤–æ‰€æœ‰çš„Ié”ï¼Œè€ŒIXå’ŒSIXéƒ½åŒ…å«åœ¨äº†ä»¥ä¸Šä¸¤ç§æƒ…å†µä¸‹äº†ï¼ˆIXæ˜¯2ï¼ŒSIXæ˜¯1ï¼‰ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹æ— è®ºrequestæ˜¯Sè¿˜æ˜¯Xéƒ½å¯ä»¥ç›´æ¥æ›¿æ¢æ‰
   1. å…·ä½“æµç¨‹å°±æ˜¯å…ˆancestorEnsuringï¼Œç„¶ååœ¨è¯¥å±‚escalateï¼Œæœ€ååˆ¤æ–­è¯¥å±‚æ˜¯å¦æ»¡è¶³requestï¼Œè‹¥ä¸æ»¡è¶³å†è¿›è¡Œpromote
4. å‰©ä¸‹çš„æƒ…å†µæ˜¯å½“å‰å±‚effectiveLockä¸èƒ½è¦†ç›–requestï¼Œè€Œä¸”å½“å‰æŒæœ‰çš„ä¸æ˜¯intent lockï¼Œåªèƒ½æ˜¯Sæˆ–è€…NL
   1. effectiveLockæ˜¯NLï¼Œç›´æ¥acquire
   1. effectiveLockæ˜¯Sï¼Œè¿™ç§æƒ…å†µä¸‹ï¼ŒSå¯èƒ½æ¥æºäºè‡ªèº«å¸¦çš„é”ï¼Œå¯èƒ½æ˜¯æ¥æºäºéšå¼é”
      1. è‹¥explicitLockæ˜¯Sï¼ŒancestorEnsuringåè¯¥å±‚ç›´æ¥promoteä¸ºrequestå³å¯
      1. è‹¥explicitLockæ˜¯NLï¼Œéšå¼é”å¯èƒ½æ¥æºäºä¸Šå±‚çš„Sæˆ–è€…SIXï¼Œé‚£ä¹ˆç­‰ä»·äºæ”¹å˜ä¸Šå±‚çš„é”ï¼Œé€’å½’è°ƒç”¨æœ¬å‡½æ•°`_ensureSufficientLockHeld_(parentContext,requestType);`_å³å¯_
## Part-2ï¼šTask 5: Two-Phase Locking

- [x] å…³äºä»€ä¹ˆæ˜¯2PLï¼Œä»¥åŠ2PLå’Œstrict 2PLä¹‹é—´çš„åŒºåˆ«

è¿™ä¸¤ç§éƒ½æ˜¯é¿å…æ­»é”çš„æ–¹å¼ï¼Œ2PLå°±æ˜¯åœ¨åŒä¸€ä¸ªtractionä¸­åœ¨é”çš„è·å–è¿‡ç¨‹ä¸­ä¸èƒ½é‡Šæ”¾ä¹‹å‰è·å–çš„é”ï¼Œåªæœ‰å½“æ‰€æœ‰çš„é”éƒ½è·å–å®Œæ¯•ä»¥åæ‰èƒ½é‡Šæ”¾é”ï¼Œæ‰€ä»¥2PLæ•´ä¸ªæµç¨‹ä¸­æŒæœ‰é”çš„ç¤ºæ„å›¾å¦‚ä¸‹
![image.png](https://cdn.nlark.com/yuque/0/2022/png/25488814/1658043892670-05d78de1-225b-445a-8942-89bf090abe9b.png#clientId=ua1996f64-888b-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=320&id=u8b5c08fb&margin=%5Bobject%20Object%5D&name=image.png&originHeight=400&originWidth=876&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12450&status=done&style=none&taskId=uda6204f0-5896-44b8-bf1d-f5a96d58d99&title=&width=700.8)
ä½†æ˜¯2PLæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œä¸€æ—¦é‡Šæ”¾è¿‡ç¨‹ä¸­è¯¥transactionå¥”æºƒäº†éœ€è¦å›æ»šï¼Œä½†æ˜¯å…¶ä»–transactionå·²ç»è·å–äº†éƒ¨åˆ†é‡Šæ”¾çš„é”ï¼Œä¼šäº§ç”Ÿè„è¯»çš„é—®é¢˜ï¼Œæ‰€ä»¥æå‡ºäº†strict 2PLçš„æ¦‚å¿µï¼Œæ‰€æœ‰çš„é”å¿…é¡»åœ¨tractionç»“æŸæ—¶ç»Ÿä¸€é‡Šæ”¾ï¼Œç¤ºæ„å›¾å¦‚ä¸‹
![image.png](https://cdn.nlark.com/yuque/0/2022/png/25488814/1658044300420-24f10537-92b1-4974-b1b9-b9c3916c34e2.png#clientId=ua1996f64-888b-4&crop=0&crop=0&crop=1&crop=1&from=paste&height=310&id=ufe112595&margin=%5Bobject%20Object%5D&name=image.png&originHeight=388&originWidth=847&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17107&status=done&style=none&taskId=ua7be8da2-f791-4e4b-ae96-90e956a657f&title=&width=677.6)
è¿™ä¸ªprojecté‡‡ç”¨çš„æ˜¯strict 2PLï¼Œæ‰€ä»¥æ‰€æœ‰æŒæœ‰çš„é”åº”è¯¥åœ¨transactionç»“æŸçš„æ—¶å€™è¿›è¡Œé‡Šæ”¾ï¼Œå…·ä½“æµç¨‹å‚ç…§æ³¨é‡Šå®Œæˆå³å¯ï¼Œä¸éš¾

- [x] å…³äºé‡Šæ”¾é”çš„é¡ºåºå’Œå®ç°

ç”±äºè°ƒç”¨lockContextçš„releaseæ–¹æ³•ä¼šé¦–å…ˆæ£€æŸ¥å­èŠ‚ç‚¹çš„é”æ˜¯å¦é‡Šæ”¾å®Œæ¯•ï¼Œæ‰€ä»¥é”çš„é‡Šæ”¾é¡ºåºå¿…é¡»æ˜¯ä»ä¸‹åˆ°ä¸Šï¼Œå®ç°çš„æ€è·¯ç±»ä¼¼BFSçš„å±‚åºéå†ï¼Œæ¯ä¸€æ¬¡å–å‡ºnumchildrenä¸º0 çš„locksï¼Œåœ¨é‡Šæ”¾çš„åŒæ—¶æ›´æ–°çˆ¶èŠ‚ç‚¹çš„numChildrenç›´åˆ°listä¸ºç©ºï¼Œæ‰€æœ‰çš„é”å‡é‡Šæ”¾å®Œæ¯•
## Testing
éœ€è¦å†™ä¸€ä¸ªå…³äºIX promoteä¸º_SIXçš„æµ‹è¯•ä»£ç ç»ƒç»ƒæ‰‹_
```java
 @Test
public void testPromoteSIXSaturation() {
        // your test code here
        TransactionContext t1 = transactions[1];
        dbLockContext.acquire(t1,LockType.IX);
        tableLockContext.acquire(t1,LockType.IS);
        pageLockContext.acquire(t1,LockType.S);
        dbLockContext.promote(t1,LockType.SIX);
        assertEquals(0,dbLockContext.getNumChildren(t1));

        }
```